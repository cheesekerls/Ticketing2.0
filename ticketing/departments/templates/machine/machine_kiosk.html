{% extends "admin_dashboard.html" %}
{% load static %}

{% block title %}Manage Machines / Kiosks{% endblock %}

{% block content %}
<div class="container py-4" style="max-width:1200px; margin:auto;">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0" id="pageTitle">Manage Machines / Kiosks</h2>
    <div class="d-flex align-items-center">
      <!-- Add Admin Button -->
      <button id="addBtn" class="btn btn-dark-blue rounded-pill px-4 shadow-sm">
        + Add Machine
      </button>

      <!-- Back Arrow Button -->
      <button id="backBtn" class="btn btn-outline-dark rounded-pill px-4 shadow-sm d-none">
        &#8592;
      </button>
    </div>
  </div>

  <!-- Add Admin / Machine Form -->
  <div id="addMachineForm" class="collapse mb-4">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body p-4">
        <h5 class="card-title mb-3">Add New Machine / Kiosk</h5>
        <form method="POST" class="row g-3">
          {% csrf_token %}
          <div class="col-md-4">
            <label class="form-label fw-semibold">MAC Address</label>
            {{ form.mac_address }}
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Role</label>
            {{ form.role }}
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Department</label>
            {{ form.department }}
          </div>
          <div class="col-12 mt-2">
            <button type="submit" class="btn btn-dark-blue rounded-pill px-4">Add Machine</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Machine List Table -->
  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-body p-4">
      <h5 class="card-title mb-3">Existing Machines / Kiosks</h5>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="bg-dark text-white rounded-top">
            <tr>
              <th class="text-center">ID</th>
              <th>MAC Address</th>
              <th>Role</th>
              <th>Department</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for kiosk in kiosks %}
            <tr class="table-row-hover">
              <td class="text-center fw-semibold">{{ kiosk.comp_id }}</td>
              <td>{{ kiosk.mac_address }}</td>
              <td>{{ kiosk.role }}</td>
              <td>{{ kiosk.department.department_name }}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-dark rounded-pill me-2 px-3"
                        data-bs-toggle="modal"
                        data-bs-target="#editModal"
                        data-id="{{ kiosk.comp_id }}"
                        data-mac="{{ kiosk.mac_address }}"
                        data-role="{{ kiosk.role }}">
                  Edit
                </button>
                <button class="btn btn-sm btn-outline-danger rounded-pill px-3"
                        onclick="confirmDelete('{{ kiosk.comp_id }}')">
                  Delete
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">No machines or kiosks found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow rounded-4">
      <div class="modal-header border-0 bg-dark text-white rounded-top-4">
        <h5 class="modal-title">Edit Machine / Kiosk</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="editForm" method="post">
        {% csrf_token %}
        <input type="hidden" id="edit_id" name="edit_id">
        <div class="modal-body px-4 py-3">
          <div class="mb-3">
            <label class="form-label fw-semibold">MAC Address</label>
            <input type="text" id="edit_mac_address" name="mac_address" class="form-control form-control-lg rounded-3" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Role</label>
            <input type="text" id="edit_role" name="role" class="form-control form-control-lg rounded-3" required>
          </div>
        </div>
        <div class="modal-footer border-0 pb-4">
          <button type="submit" class="btn btn-dark-blue rounded-pill px-4">Save</button>
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const addBtn = document.getElementById('addBtn');
  const backBtn = document.getElementById('backBtn');
  const addForm = document.getElementById('addMachineForm');

  // Show form and back button
  addBtn.addEventListener('click', function() {
    const collapse = new bootstrap.Collapse(addForm, {toggle: true});
    addBtn.classList.add('d-none');
    backBtn.classList.remove('d-none');
  });

  // Hide form and show add button
  backBtn.addEventListener('click', function() {
    const collapse = new bootstrap.Collapse(addForm, {toggle: true});
    backBtn.classList.add('d-none');
    addBtn.classList.remove('d-none');
  });

  // Prefill Edit Modal
  const editModal = document.getElementById('editModal');
  const editForm = document.getElementById('editForm');

  editModal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const mac = button.getAttribute('data-mac');
    const role = button.getAttribute('data-role');

    editForm.action = "{% url 'update_kiosk' 0 %}".replace("0", id);
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_mac_address').value = mac;
    document.getElementById('edit_role').value = role;
  });

  // Delete confirmation
  window.confirmDelete = function(id) {
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to undo this.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#1e3a5f',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, delete it'
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = "{% url 'delete_kiosk' 0 %}".replace("0", id);
      }
    });
  };

  // Django messages with SweetAlert2
  {% if messages %}
    {% for message in messages %}
      Swal.fire({
        icon: '{{ message.tags }}' === 'error' ? 'error' : 'success',
        title: '{{ message|escapejs }}',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
      });
    {% endfor %}
  {% endif %}
});
</script>

<style>
.table thead th {
  border: none;
  font-weight: 600;
  letter-spacing: 0.5px;
}
.table tbody td {
  vertical-align: middle;
  color: #333;
}
.table-row-hover:hover {
  background-color: #f8f9fa !important;
  transition: all 0.3s ease;
}
.btn {
  transition: all 0.3s ease;
  border-radius: 50px;
}
.btn-dark-blue {
  background-color: #1e3a5f;
  color: white;
  border: none;
}
.btn-dark-blue:hover {
  background-color: #16314a;
  color: white;
}
.modal-content {
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.96); }
  to { opacity: 1; transform: scale(1); }
}
</style>
{% endblock %}
